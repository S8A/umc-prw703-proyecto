<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de entrenamiento &ndash; 8A Training</title>

    <link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <nav>
            <div class="container">
                <a href="/" class="logo">
                    <img src="/assets/img/8a-training-full-bg.svg" alt="Inicio">
                </a>
                <ul>
                    <li><a href="/historial/">Historial</a></li>
                    <li><a href="/recursos.html">Recursos</a></li>
                    <li><a href="/iniciar-sesion.html">Iniciar sesión</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <main>
        <div class="container training-log">
            <div id="status-messages"></div>
            <h1 id="main-title">Historial de entrenamiento</h1>
            <div id="main-buttons">
                <a href="/historial/crear.html" class="btn">Registrar sesión</a>
            </div>
            <div>
                <form id="date-filter" role="search" aria-labelledby="date-filter-label">
                    <label for="date" id="date-filter-label">Filtrar por fecha:</label>
                    <input type="date" name="date" id="date-filter-input">
                    <button type="submit">Buscar</button>
                </form>
            </div>
            <div id="training-sessions">
                <p id="empty-text">No se ha encontrado ninguna sesión de entrenamiento.</p>
            </div>

            <nav aria-label="Páginas">
                <ul id="pagination">
                    <li>Anterior</li>
                    <li>Página 1 de 5</li>
                    <li><a href="?page=2">Siguiente</a></li>
                </ul>
            </nav>
        </div>
    </main>
    <footer>
        <div class="container">
            <p>Samuel Ochoa · UMC PRW703 · 2022</p>
        </div>
    </footer>
    <script type="module">
        import * as utils from '/assets/js/utils.js';

        window.addEventListener('load', function () {
            let signedInAccount = utils.getSignedInAccount();
            if (signedInAccount) {
                // Set up signed-in header
                utils.setUpSignedInHeader(signedInAccount);

                // Get query params
                const params = utils.getQueryParams();
                
                // Get page number from query parameter
                let page = 1;
                if (params.page) {
                    let pageNumber = Number(params.page);
                    
                    if (pageNumber.isNaN() || pageNumber <= 0) {
                        // Redirect to first page if page number is 
                        // not a number, zero or negative
                        let query = {};
                        if (params.date) {
                            query.date = params.date;
                        }
                        utils.setQueryParams(query);
                    } else {
                        page = pageNumber;
                    }
                }

                // Get this account's training sessions, filtered 
                // by the date parameter
                let sessions = utils.getTrainingSessions(params.date);

                // Compute indexes of first and last items
                const itemsPerPage = 10;
                let first = itemsPerPage * (page - 1);
                let last = first + itemsPerPage;

                // Compute previous and next page numbers
                let previousPage = (page === 1) ? null : page - 1;
                let nextPage = (last >= sessions.length) ? null : page + 1;

                if (first > page.length) {
                    // Redirect to previous page if the page number is too high
                    let query = {};
                    if (params.date) {
                        query.date = params.date;
                    }
                    query.page = previousPage;
                    utils.setQueryParams(query);
                }

                // Keep only this page's training sessions
                sessions = sessions.slice(first, last);

                // Text element that indicates that no sessions were found
                let emptyText = document.querySelector('#empty-text');

                if (sessions) {
                    // Hide empty text element
                    emptyText.style.display = 'none';
                }

                // Append sessions data to page
                // TODO: Implement correctly
                let trainingSessions = document.querySelector(
                    '#training-sessions');
                let sessionsList = document.createElement('ul');
                for (let session of sessions) {
                    let trainingSession = document.createElement('li');
                    trainingSession.textContent = JSON.stringify(session);
                    sessionsList.appendChild(trainingSession);
                }
                trainingSessions.append(sessionsList);
            } else {
                window.location.assign('/iniciar-sesion.html?next=/historial/');
            }
        });
    </script>
</body>
</html>
